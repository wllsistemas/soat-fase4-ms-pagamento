FROM php:8.4-fpm-alpine3.22

WORKDIR /var/www/html

# 1. Dependências de Sistema e Build
RUN apk add --no-cache \
    bash curl git unzip zip ca-certificates libstdc++ libpq-dev \
    && apk add --no-cache --virtual .build-deps autoconf g++ make linux-headers

# 2. Instalação e Ativação das Extensões
RUN pecl install mongodb \
    && docker-php-ext-enable mongodb \
    && docker-php-ext-install sockets pcntl bcmath \
    && docker-php-ext-enable sockets pcntl bcmath

# 3. Instalação do Composer
RUN curl -sS https://getcomposer.org/installer | php -- --install-dir=/usr/local/bin --filename=composer

# 4. Configuração para ignorar advisory de segurança do firebase/php-jwt
ENV COMPOSER_AUDIT_IGNORE=PKSA-y2cr-5h3j-g3ys

# 5. Copia o código fonte ANTES do composer install (para scripts post-install)
COPY ./backend .

# 6. Instalação das dependências (com código presente)
RUN composer install --no-dev --prefer-dist --no-interaction --no-progress --optimize-autoloader

# 7. Limpeza de dependências de build
RUN apk del .build-deps && rm -rf /var/cache/apk/*

# 8. Permissões Laravel
RUN chown -R www-data:www-data storage bootstrap/cache

CMD ["php-fpm", "-F"]